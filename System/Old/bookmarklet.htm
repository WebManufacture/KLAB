<style type="text/css">
  #MRT-IS-OSC-faveletDiv
  {
    font-family: verdana;
    font-size: 12px;
    position:fixed;
    z-index: 10;
    opacity: .9;
    top: 100px;
    right: 100px;
    background-image:url(data:image/gif;base64,R0lGODlhAwADAIAAANve4f/7/yH5BAAAAAAALAAAAAADAAMAAAIETHAZBQA7);
    border: solid 1px gray;
    border-radius: 10px;
    -moz-border-radius: 10px;
    width: 300px;
    height: 260px;
    padding-top: 40px;
  }
  
  #MRT-IS-OSC-faveletDiv .status-box
  {
    background-color: none;
    opacity: 0.7;
    border-top: solid 1px gray;
    width: 100%;
    height: 25px;
    text-align: center;
    cursor: default;
    padding-top: 4px;
    position: absolute;
    bottom: 0px;
    left: 0px;
  }
  
  
  
  #MRT-IS-OSC-faveletDiv .status-box .status-box-load-image
  {
    top: 1px;
    left: 2px;
    display: none;
    margin-left: 40px;
  }
  
  #MRT-IS-OSC-faveletDiv .status-box.ajax-load .status-box-load-image
  {
    display: block;
  }
  
  #MRT-IS-OSC-faveletDiv .header
  {
    background-color: orange;
    border: solid 1px darkorange;
    border-radius: 5px;
    -moz-border-radius: 5px;
    font-size: 16px;
    width: 80%;
    height: 25px;
    margin-left: 10%;
    margin-right: 10%;
    top: 6px;
    text-align: center;
    cursor: default;
    padding-top: 4px;
    position: absolute;
  }
  
  #MRT-IS-OSC-faveletDiv .drop-place
  {
    background-color: white;
    border: solid 1px darkorange;
    border-radius: 5px;
    -moz-border-radius: 5px;
    width: 96%;
    margin-left: 2%;
    margin-right: 2%;
    height: 40px;
    text-align: center;
    float:left;
    margin: 2px;
    padding-top: 4px;
    text-align: center;
  }
  
  #MRT_IS_OSC_BOOKMARKLET_ImagesCatcher
  {
    background-color: gray;
    border: solid 1px darkorange;
    border-radius: 5px;
    -moz-border-radius: 5px;
    width: 96%;
    margin-left: 2%;
    margin-right: 2%;
    height: 40px;
    text-align: center;
    margin: 2px;
    padding-top: 4px;
    text-align: center;
  }
  
  #MRT-IS-OSC-faveletDiv .drop-place.image-drag-active
  {
    background-color: #99CCFF;
  }
  
   #MRT-IS-OSC-faveletDiv .drop-place .File
   {
       margin-top: 10px;
     display: block;
   }
   
   #MRT-IS-OSC-faveletDiv .drop-place .File .tags
   {
     display: none;
   }
  
  #MRT-IS-OSC-faveletDiv .drop-place.image-drag-accept
  {
    background-color: #33CC00;
  }
  
  .MRT_IS_OSC_BOOKMARKLET_image-drop-active
  {
     border: solid 2px blue;
  }
  
  .MRT_IS_OSC_BOOKMARKLET_image-drop-accept
  {
     border: solid 2px red;
  }
  
  /*.ui-draggable-dragging
  {
    z-index: 11;
    position: fixed!important;
  }*/
    
    #MRT-IS-OSC-faveletDiv .header:hover
      {
      background-color: #FFCC33; 
  }
  
  #MRT-IS-OSC-faveletDiv .header .close-button
  {
    position: absolute;
    top: 1px;
    right: 2px;
    width: 24px;
    height: 24px;
    float: right;
    background: url("gtk-close.png") no-repeat;
  }
  
  #MRT-IS-OSC-faveletDiv .header .close-button:hover
  {
    border: dotted 1px gray; 
  }
  
  a:visited
  {
    text-weigth: regular!important; 
  }
   
</style>

<script type="text/javascript" src="jquery-1.4.2.js"></script>
<script type="text/javascript" src="jquery-ui-1.8.4.custom.js"></script>
<script type="text/javascript" src="UrlProcessor.js"></script>

<script type="text/javascript">
  window.MRT_IS_OSC_BOOKMARKLET_CONTROLLER = {
    parentContainer : null,
    
    Init: function()
    {
      this.parentContainer = $("#MRT-IS-OSC-faveletDiv");
      this.parentContainer.draggable({ handle : ".header"});
      $("img").draggable({zIndex: 11, revert: true, opacity: 0.5, helper: "clone"});
    $("img").droppable({accept:"#MRT_IS_OSC_BOOKMARKLET_ImagesCatcher", activeClass: 'MRT_IS_OSC_BOOKMARKLET_image-drop-active', hoverClass: 'MRT_IS_OSC_BOOKMARKLET_image-drop-accept', drop: this.ImageCatching});
      $.ajaxSetup({complete: this.OnAjaxComplete, global: true})
      $("img").addClass("MRT_IS_OSC_BOOKMARKLET_Images_draggableClass");
      $("img").attr("draggable", "true");
    $("#MRT_IS_OSC_BOOKMARKLET_ImagesCatcher").draggable({zIndex: 11, helper: "clone"});
      $("#MRT_IS_OSC_BOOKMARKLET_ImagesDropPlace").droppable({accept:".MRT_IS_OSC_BOOKMARKLET_Images_draggableClass", activeClass: 'image-drag-active', hoverClass: 'image-drag-accept', drop: this.ImageDropped});
      $.ajaxSetup({complete: this.OnAjaxComplete, global: true});
    },
    
    Load_binary_resource: function(url, OnLoadResource) {  
      var req = new XMLHttpRequest();  
      req.open('GET', url, true);  
      //XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com]  
      req.overrideMimeType('text/plain; charset=x-user-defined');  
      req.onload=OnLoadResource;
      req.onerror=this.OnAjaxComplete;

      var urlParser = new URL(url)
      url=urlParser.pathname();
      url=url.split("/");
      url=url[url.length-1];
      req.fileName = url;
      req.send(null);
      return req;
    },
        
    ImageDropped: function(event, ui){
      var src = ui.draggable.attr("src");
      $("#MRT-IS-OSC-faveletDiv .status-box").addClass("ajax-load");
      $("#MRT-IS-OSC-faveletDiv .container").hide();
      MRT_IS_OSC_BOOKMARKLET_CONTROLLER.Load_binary_resource(src, MRT_IS_OSC_BOOKMARKLET_CONTROLLER.ImageDownloaded)
    },
    
  ImageCatching: function(event, ui){
      var src = $(this).attr("src");
      $("#MRT-IS-OSC-faveletDiv .status-box").addClass("ajax-load");
      $("#MRT-IS-OSC-faveletDiv .container").hide();
      MRT_IS_OSC_BOOKMARKLET_CONTROLLER.Load_binary_resource(src, MRT_IS_OSC_BOOKMARKLET_CONTROLLER.ImageDownloaded)
    },
  
    ImageDownloaded: function(event)
    {      
        var url = MRT_IS_OSC_Bookmarklet.ServerAddress + "System.ContentHandler.ashx?path=UserFiles&action=save&file=" + escape(this.fileName);
      var req = new XMLHttpRequest();  
      req.open("POST", url, true);  
      // set headers and mime-type appropriately  
      var size = this.getResponseHeader("Content-Length");
      req.setRequestHeader("Content-Length", size);  
      req.onload=MRT_IS_OSC_BOOKMARKLET_CONTROLLER.ImageUploaded;
      req.onerror=MRT_IS_OSC_BOOKMARKLET_CONTROLLER.OnAjaxComplete;
     
      var filestream= this.responseText;
      var newstream = "";
      for (var i = 0; i < size; i++) {
           newstream += String.fromCharCode(filestream.charCodeAt(i) & 255);
      }
      req.sendAsBinary(newstream);      
    },
    
    ImageUploaded: function()
    {
    var name = $(this.responseText).attr("name");
      MRT_IS_OSC_BOOKMARKLET_CONTROLLER.OnAjaxComplete();
      $("#MRT-IS-OSC-faveletDiv .status-box .status-box-info-message").html("Загружено - " + name);
    $("#MRT-IS-OSC-faveletDiv #MRT_IS_OSC_BOOKMARKLET_ImagesDropPlace").append(this.responseText);
      $("#MRT-IS-OSC-faveletDiv .status-box .status-box-info-message").fadeIn(800);
      window.setTimeout(MRT_IS_OSC_BOOKMARKLET_CONTROLLER.ClearStatus, 3000);
    },
    
    ClearStatus : function()
    {
      $("#MRT-IS-OSC-faveletDiv .status-box .status-box-info-message").fadeOut(800);
    },
    
    OnAjaxComplete: function()
    {
      $("#MRT-IS-OSC-faveletDiv .status-box").removeClass("ajax-load");
      $("#MRT-IS-OSC-faveletDiv .container").show();
    },
    
    ElementDragged: function()
    {
      
    }
  }  
    
    $(MRT_IS_OSC_BOOKMARKLET_CONTROLLER.Init());
</script>

<div class="header">
  <span>Фабрика сайтов</span>
  <div class="close-button" onclick="MRT_IS_OSC_BOOKMARKLET_CONTROLLER.parentContainer.remove()"></div>
</div>

  <div class="" id="MRT_IS_OSC_BOOKMARKLET_ImagesCatcher">
     Перетащите этот контейнер на картинку
  </div>
  
<div class="drop-place container" id="MRT_IS_OSC_BOOKMARKLET_ImagesDropPlace">
  Контейнер для картинок  <br/>
  </div>
  
    
    <div class="status-box">
      <img class="status-box-load-image" src="load.gif"></img>
      <span class="status-box-info-message"></span>
    </div> 
