	<!DOCTYPE html>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
		<link type='text/css' rel='stylesheet' href="http://Services.web-manufacture.net/Styles/System.default.css"/>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Utils.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/DOM.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Events.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Log.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Url.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Ajax.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Jasp.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Modules.js"></script>
	
	
	<script type="text/javascript" src="http://system.web-manufacture.net/CodeMirror-2.32/lib/CodeMirror.js"></script>
	<link rel="stylesheet" href="http://system.web-manufacture.net/CodeMirror-2.32/lib/codemirror.css"/>
	
	<script src="http://system.web-manufacture.net/CodeMirror-2.32/mode/javascript/javascript.js"></script>
	<script src="http://system.web-manufacture.net/CodeMirror-2.32/mode/htmlmixed/htmlmixed.js"></script>
	<script src="http://system.web-manufacture.net/CodeMirror-2.32/mode/css/css.js"></script>
	<script src="http://system.web-manufacture.net/CodeMirror-2.32/mode/xml/xml.js"></script>
	
	<include url='http://services.web-manufacture.net/Base/v1.3/ui.js'></include>
	<include url='http://services.web-manufacture.net/UI/toolbars.htm'></include>
	<include url='http://services.web-manufacture.net/UI/Notification.htm'></include>
	
	<div class="header toolbar">
		<div class="menuitem save" tooltip="Сохранить" icon="http://system.web-manufacture.net/Images/save-mini.png" onclick="Editor.SaveFile();"></div>
		  <div class="menuitem save" tooltip="История сохранений" icon="http://system.web-manufacture.net/Images/save-mini.png" onclick="Editor.ShowHistory();"></div>
		  <div class="separator"></div>
		  <div class="menuitem color" style="background-size: 48px 48px;" tooltip="Палитра" icon="http://system.web-manufacture.net/Images/color.png" onclick="M.LoadModule('System.ColorPalette.htm');"></div>
		  <div class="menuitem" tooltip="CSS" icon="http://system.web-manufacture.net/Images/text-css.png" onclick="M.LoadModule('Designer.CssPalette.htm');"></div>
		  <div class="separator"></div>
		  <div class="menuitem" tooltip="RUN" icon="http://system.web-manufacture.net/Images/exec.png"  onclick="window.open('system.index.htm?file=' + Editor.fileName);"></div>
		  <div class="menuitem" tooltip="Запустить и сохранить" icon="http://system.web-manufacture.net/Images/emblem-system.png"  onclick="Editor.SaveFile(); Editor.NeedRun = true;">Сохранить и Запустить</div>
		  <div class="menuitem" tooltip="Запустить" icon="http://system.web-manufacture.net/Images/emblem-system.png"  onclick="Editor.RunFile();">Запустить</div>
		  <div class="status"></div>
	  </div>
	<div id='VersionHistory' class='invisible'></div>
	<script type="text/javascript" key="TextEditor">
			
	  function XH(){
			var xmlhttp;
			xmlhttp = new XMLHttpRequest();
			return xmlhttp;
			};
		
	  Editor = {};    
	  
	  Editor.Init = function(){
		if (Request.Params.url){
		var req = XH();
		req.open("GET", Request.GetUrl(Request.Params.url), true);
		req.onload = Editor.LoadFileComplete;
		req.send(null);
		}
		window.onkeypress = Editor.KeyHandler;
	  }  
	
		Editor.LoadFileComplete = function(result) {
		result = this.responseText;
		  var parsers = "";
		  var header = this.getResponseHeader("Content-Type");
		  if (header != null) 
		  {
			if (header.Contains(["text/html", "text/htm"])) {
		  parsers = "htmlmixed";
			}
			if (header.Contains(["text/javascript", "application/x-javascript", "text/js"])) {
			  parsers = "javascript";
			}
			if (header.Contains("text/css")) {
			  parsers = "css";
			}
			if (header.Contains("text/xml")) {
			  parsers = "xml";
			}
		  }
		  Editor.TextEditor = CodeMirror(WS.Body, {
			mode: parsers,
			indentUnit : 4,
			indentWithTabs : true,
			smartIndent : true,
			lineNumbers : true,
			matchBrackets : true,
			electricChars : true,});
			
		  Editor.TextEditor.setValue(this.responseText);
		  var title = WS.Header.add("<title>" + Request.Params.url + "</title>");
		}
	
		Editor.SaveFile = function() {
			if (Request.Params.url) {
			  DOM(".menuitem.save").hide();
			  var content = Editor.TextEditor.getValue();
		  
			  var req = XH();
			  req.open("POST", Request.GetUrl(Request.Params.url), true);
			req.setRequestHeader("Content-Type", "text/plain");
			  req.onload = Editor.SaveComplete;
			  req.send(content);
		  } 
			
		}
		  
		Editor.SaveComplete = function(){
			var status = DOM.get(".header .status");
			var div = DOM.div(null, this.responseText);
			Notify.Show("Сохранено");
			DOM.get(".menuitem.save").show();
		};
		
		Editor.RunFile = function(){
		if (Request.Params.url){
			window.open(Request.GetUrl(Request.Params.url));
		}
		};
	
		Editor.TextReindentAll = function() {
			this.TextEditor.reindent();
		}
		 
		Editor.KeyHandler = function(event){
		  // Ctrl + S event;
		  if (event.ctrlKey && event.charCode == 115){
			Editor.SaveFile();
			event.stopPropagation();
			event.preventDefault();
			return false;
		  }
		  return true;
		}
		  
		WS.DOMload(Editor.Init);
	
	</script>
	  
	<style type="text/css">
	  body{
	   background-color: #eee;  
	
	  } 
	  
	  
	  .CodeMirror {
	   line-height: 1em;
	   font-family: monospace;
	   padding-top: 70px;
	 }
		.CodeMirror-scroll{
			height: auto; overflow: visible;	
		}
		
	.CodeMirror-lines {
	  padding: .4em;
	}
	
	</style>

