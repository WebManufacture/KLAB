<!DOCTYPE html>

<meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta>

<title>XEditor</title>

<link type='text/css' rel='stylesheet' href="System.default.css"/>
<script type="text/javascript" src="System.JS.js"></script>
<script type="text/javascript" src="System.Utils.js"></script>
<script type="text/javascript" src="System.Jasp.js"></script>
<script type="text/javascript" src="System.AJAX.js"></script>
<script type="text/javascript" src="System.Modules.js"></script>

<module url="System.XEditor.htm">

<script type="text/javascript" url="System.XEditor.js"></script>
  
<include url="System.Dragging.htm"></include>
<include url="System.Notification.htm"></include>
<include url="System.Windows.htm"></include>
<include url="System.Toolbars.htm"></include>
<include url="System.XTagsMenu.htm"></include>    
<include url="XTagsContainer.htm"></include>



<win class="xml_editor" module="System.XEditor.htm" type="fullscreen" title="X-Editor" oninit="XE.InitXEWindow">
	<div class="header toolbar">
          <div class="menu subbar">
            <div class="menuitem" menu="Select" title="Toggle selection" icon="edit-select-all.png" onclick="XmlEditor.RemoveSelection();">
            </div>
            <div class="menuitem" menu="Show" title="Show/hide attr" icon="showreel.png" onclick="XmlEditor.ShowAttributes();">
            </div>
            <div class="menuitem" menu="Delete" icon="delete-mini.png" onclick="XmlEditor.Menu.DeleteSelected();">
            </div>
            <div class="menuitem save" menu="Save" icon="save-small.png" onclick="XmlEditor.Save();">
            </div>
          </div>
           
        </div>
        <div class="element-menu">
            <div class="item" icon="css.png" onclick="XE.ShowCss();">              
            </div>
            <div class="item" icon="delete-mini.png" onclick="XE.Menu.Delete();">              
            </div>
         
        </div>
        <div id="xmlContainer" class="xml-content">

        </div>


        
</win>
  <win class="element-editor invisible no-close">
          <div class="header eeditor toolbar">
	    <div class="subbar">
              <div class="menuitem" menu="Save" title="Save" icon="save-small.png" onclick="XmlEditor.EE.Save();">
              </div>
            </div>
          </div>
          <div class="name"></div>
          <div class="id"></div>
          <div class="classes"></div>
          <div class="clear"></div>
          <div class="attributes"></div>
          <div class="values"></div>
        </win>

<style type="text/css">
    .xml_editor
    {
        /* background: #FFF;
        border: solid 1px black;
        position: absolute;
        width: 300px;
        height: 300px;
        top: 0px;
        left: 0px;
        z-index: 190;
        background-image:url(data:image/gif;base64,R0lGODlhAwADAIAAANve4f/7/yH5BAAAAAAALAAAAAADAAMAAAIETHAZBQA7);
    	*/
    }
  
  .window .xml_editor{
    position: relative;
  }
  
  
  /* ------------- ELEMENT EDITOR ================= */
  
  .window.element-editor{
    position: fixed;
    top: 20%;
    left: 30%;
    width: 40%;
    height: 60%;
    border: solid 1px black;
    background-color: #EEE;
  }
  
  .element-editor .name{
color: navy;
        font-weight: bold;
        cursor: pointer;
        float: left;	
  }
  
  
      
.element-editor .id{
        color: #CC00CC;
        float: left;
        padding-left: 3px;
  }
  
  
  
.element-editor .classes{
        color: #006600;
        float: left;
  }
  
  .element-editor .classes .class-item{
            display: inline;
        padding-left: 3px;
  }
  
  .element-editor .attribute{
      color: silver;
      display: block;
      margin-left: 20px;
      display: inline;
  }
  
  
  .element-editor .attribute .aname
  { 
    display: inline;
    color: #006699;
  }

  .element-editor .attribute .avalue
  { 
    display: inline;
  }  
 
  .xml_editor .element-menu
  {
    background-color: rgba(240, 240, 0, 0.8);
    border: solid 1px silver;
    width: 50px;
    position: absolute;
    z-index: 10;
    left: 0px;  
    padding 1px 4px;  
    top: 80px;
  }
  
   .xml_editor .element-menu .item
    {
    width: 18px;
    height: 18px;
    float: left;
    background: white no-repeat center center;
    border: 1px solid gray;
    cursor: pointer;
  }
  
  .xml_editor .element-menu .item:hover;
  {
    background-color: red;
    
  }
  
  /* ------------- CONTENT ================= */
  
    .xml-content
    {
        background: white;
        height: 100%;
        width: 100%;
        padding-left: 50px;
        position: relative;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
    }
  

    .xml-content .element
    {
      margin-left: 15px;
      border-left: dotted 1px gray;
      display: block;
      color: #333;
      border: 1px solid transparent;
      font-size: 12px;
    }
  
  /* .xml-content .element.dragging
    {
    position: absolute;
  }
  
  
  .xml-content .element.dragging .line{
    display: none;
  }
  
  */
  
  .xml-content .element.dragging
  {
     width: 200px;  
    overflow: hidden;
  }
  
  
  .xml-content .element.dragging .indicator{
    display: none;
  }
  
    .xml-content .element.over
    {
       border: solid 1px #CCC;     
    }
  
    .xml-content .element.over>.name
    {
       text-shadow: 1px 1px 1px silver;
    }
  
  
    .xml-content .element.selected
    {
        background-color: #EEE!important;
    }
  
    .xml-content .element.hided
    {
        border-bottom: solid 1px gray;
    }
  
    .xml-content .element.hided>.rollup
    {
        display: none;
    }
    
    .xml-content .element.editing
    {
        background-color: #CDF;
    }
    
    .xml-content .element.current>.name
    {
        color: red!important;
    }
  
    .xml-content .indicator
    {
        width: 15px;
        height: 15px;
        float: left;
        cursor: pointer;
        text-align: center;
    }
  
    .xml-content .indicator:hover
    {
        background-color: #EEE;
    }
  
    .xml-content .element>.name
    {
        color: navy;
        font-weight: bold;
        cursor: pointer;
        float: left;
    }
 
    .xml-content .element>.id
    {
        color: #CC00CC;
        float: left;
        padding-left: 3px;
    cursor: pointer;
    }
    
    .xml-content .classes
    {
        color: #006600;
        float: left;
    }
  
  
    .xml-content .classes>.class-item
    {
        display: inline;
        padding-left: 3px;    
        cursor: pointer;
    }
  
  
    
    .xml-content .attribute
    { 
      color: silver;
      display: block;
      margin-left: 20px;
      float: left;
    }
  
    .xml-content .attribute .aname
    { 
      display: inline;
      color: #006699;
    cursor: pointer;
    }
  
    .xml-content .attribute .avalue
    { 
      display: inline;
    }  
  
  
  .xml-content .attribute.editing .avalue
  {
    background-color: #ACF;
    color: black;
  }
  
    .xml-content .element>.childs>.value
    {
        display: block;
        padding-left: 20px;
    }
  
      .xml-content .element>.childs
    {
      
        padding-left: 10px;
    }


  
  
    .xml-content input[type="text"]
    {
        font-weight: bold;
        width: 100%;
        border: none;
        background-color: transparent;
    }
  
     .xml-content .value textarea
    {
        width: 100%;
        border: none;
        background-color: transparent;
    }
  
    .xml-content .attribute input[type="text"]
    {
        width: 100%;
        background-color: transparent;
        border: none;
    }
  
  .xml-content .css
        {
            clear: both;
            padding-top: 10px;
        }
        
  .xml-content  .css .selector
        {
            float: left;
            color: #006699;
        }
  
    .xml-content  .css .selector.class
        {
            color: green;
        }
  
      .xml-content  .css .selector.id
        {
            color: #CC00CC;
        }
  
        .xml-content  .css .selector.meta
        {
            color: orange;
        }

        
  .xml-content  .css .body
        {
            clear: both;
    
            position: relative;
            padding-left: 15px;
        }
        
  .xml-content  .css .body .prop
        {
            clear: both;
        }
  
  .xml-content  .css .body:hover .maket
        {
           display : block;
        }
  
        
  .xml-content  .css .body .prop .name, .css .body .prop .val
        {
      		display: inline;
        }
        
  .xml-content  .css .body .prop .name
        {
            color: navy;
        }
  
    .xml-content  .css .body .maket
        {
    width: 100px;
    display: none;
    float: left;
    height: 100px;
    position: absolute;
    top: 0px;
    left: 200px;
    border: solid 1px gray;
        }
  
  .xml-content  .css .body .maket .inner{
    border: solid 1px #EEE; 
    width: 100%;
    height: 100%;
  }
        
    
    /* Element styles */ 
  
    .xml-content .element[name="link"] > .attribute[name="href"]
    {
        display: inline;
    }  
    
  
    .xml-content .element[name="script"] > .attribute[name="src"],  .xml-content .element[name="script"] > .attribute[name="type"]
    {
        display: inline;
    }
  
    .xml-content .element[name="link"]>.name, .xml-content .element[name="style"]>.name
    {
        color: #0099FF;
    }
  
    .xml-content .element[name="module"]{
      background-color: #FFFFF4
    }
  
    .xml-content .element[name="module"]>.name{
      color: #F70;
    }
  
    .xml-content .element[name="win"]>.name{
       color: #460;
    }
  
    .xml-content .element[name="include"]>.name,
    .xml-content .element[name="context"]>.name
    {
        color: #80A;
    }
  
    .xml-content .element[name="win"]
    {
        background-color: #EEFFF4;
    }
  
    .xml-content .element[name="style"]>.attribute[name="type"]
    {
        display: inline;
    }
  
    .xml-content .element[name="style"]>.childs
    {
      
        padding-left:30px;
    }

  
     .xml-content .class-item.filtered,  .xml-content .name.filtered,  .xml-content .id.filtered
    {
        background-color: yellow;
    }
</style>
    
    <script type="text/javascript">
    XE = XEditor = XmlEditor = M.GetModuleByUrl("System.XEditor.htm");
 
XE.InitXEWindow = function(){
  XE.Editor = W.get(".window.xml_editor");
  if (Request.File == "System.XEditor.htm"){
    XE.Editor.rcs("ui_standart_window");
    XE.Editor.cls("fullscreen");
  }
  XE.Init();
  if (Request.Params.file != null){
     X.GetText(Request.Params.file, XE.LoadFileComplete);
  } 
}
  

  
XE.Init = function(){
  XE.ElementEditor.Init();
  XE.Menu.Init();
  XmlEditor.Content = XmlEditor.Editor.get(".xml-content");
  XmlEditor.TagContainer = AArray();
  XmlEditor.ClassContainer = AArray();
  XmlEditor.IdContainer = AArray();
  XmlEditor.Source = W.div("source");
  XmlEditor.Mode = null;
  
  XE.Navigator.Init();
  XmlEditor.Content.focus();
  Drag.NoBodyDrop = true;
}

XmlEditor.LoadFileComplete = function(){
   var text = this.responseText;
  
   text = text.replace(/<!DOCTYPE ([^>]+)>/ig, "<doctype-tag>$1</doctype-tag>");
  
   text = text.replace(/<html/ig, "<html-tag");
   text = text.replace(/<\/html>/ig, "</html-tag>");

   text = text.replace(/<head>/ig, "<head-tag>");
   text = text.replace(/<\/head>/ig, "<\/head-tag>");

   text = text.replace(/<body/ig, "<body-tag");
   text = text.replace(/<\/body>/ig, "<\/body-tag>");
  
   text = text.replace(/<meta/ig, "<meta-tag");
   text = text.replace(/<\/meta>/ig, "<\/meta-tag>");  
  
  
   XE.WrapContent(text);
}

XmlEditor.CreateWindow = function() {
          var editor = new XmlEditor(W.div());
          editor = Windows.CreateWindow(editor, "ui_standart_window");
          editor.Show();
}
     
XmlEditor.Show = function(element) {
            this.Content.empty();
            this.WrapElement(this.Source, this.Content)
            this.BindEvents();
            this.Editor.RefreshTagsList();
            this.Menu.Bind();
            this.TagsMenu.Init();
    
}
  
XmlEditor.Save = function() {
  var evalues = XE.Content.findAll(".value.editing");
            for (var i = 0; i < evalues.length; i++) {
              var val = evalues[i];
              val.rcs("editing");  
              val.linkedNode.value = this.html();
              val.ratt("contenteditable");
            }
  var avalues = XE.Content.findAll(".attribute.editing");
            for (var i = 0; i < avalues.length; i++) {
              var att = avalues[i];
              att.rcs("editing");  
              att.linked.attr(att.aname, att.valElem.html());
              att.valElem.ratt("contenteditable");
            }
  if (Request.Params.file != null){
     var btn = W.get(".menuitem.save");
     btn.hide();
     var text = XE.Source.html();
     text = text.replace(/<doctype-tag>([^<]+)<\/doctype-tag>/ig, "<!DOCTYPE $1>");
    
     text = text.replace(/<html-tag/ig, "<html");
     text = text.replace(/<\/html-tag>/ig, "</html>");
  
     text = text.replace(/<head-tag>/ig, "<head>");
     text = text.replace(/<\/head-tag>/ig, "<\/head>");
  
     text = text.replace(/<body-tag/ig, "<body");
     text = text.replace(/<\/body-tag>/ig, "<\/body>");
    
     text = text.replace(/<meta-tag/ig, "<meta");
     text = text.replace(/<\/meta-tag>/ig, "<\/meta>");  
    
     var request = X.ContentSave(Request.Params.file, text, XE.SaveComplete);
  }
}
  
XmlEditor.SaveComplete = function(){
   var name = W.Wrap(this.responseText).get(".name");
   Notify.Show("Сохранено - " + name.html());
   var btn = W.get(".menuitem.save");
   btn.show();
}
  
       
          


XmlEditor.GetNewElem = function(elem){
        var tag = W.div("element " + elem.sname);
        tag.linked = elem;
        elem.Synchronize = XE.Synchronize;
        elem.SynchronizeAttr = XE.SynchronizeAttr;
        tag.Synchronize = XE.Synchronize;
        tag.SynchronizeAttr = XE.SynchronizeAttr;
        tag.SynchronizeClasses = XE.SynchronizeClasses;
        tag.BindEvents = XE.BindEvents;
        tag.AddClass = XE.AddClass;
  	tag.AddAttribute = XE.AddAttribute;
  	tag.attr("drag-type", "self");
        return tag;
      },
        
     
    
HTMLElement.CheckChild = function(tag, classes, value){
    var item = this.child(tag);
    if (item == null){
        item  = W.div(classes, value, this);
    }
    else
    {
      if (classes != undefined && classes != null){
        this.cls(classes);
      }
      if (value != undefined && value != null){
        this.html(value);
      }
    }
    return item;
  },
      
XmlEditor.Synchronize = function(element) {
   var name = element.sname;
   this.attr("name", name);
   var id = element.attr("id");
   if (id != null && id != undefined) {
       this.attr("identifier", id);
   }
   XE.TagContainer.uadd(name);
   XE.IdContainer.uadd(id);
   this.indicator = this.adv("indicator");
   this.nameElem = this.adv("name", name);
   if (id == null) id = "";
   else id = '#' + id;
   this.identifierElem = this.adv("id", id);
   this.identifierElem.onclick = XE.IdClick;
   this.classesElem = this.adv("line classes");
   this.SynchronizeClasses(element);
   this.attrElem = this.adv("line rollup attributes");
   this.SynchronizeAttr(element);
   this.adv("clear");
   this.innerNodes = this.adv("line rollup childs");
   this.BindEvents();
},
  
XmlEditor.SynchronizeClasses = function(element) {
        var classes = element.classList;
        this.classesElem.clear();
        for (var i = 0; i < classes.length; i++) {
          
          var classItem = classes[i];
          XE.ClassContainer.uadd(classItem);
          this.AddClass(classItem);
        }
}
  
XmlEditor.AddClass = function(cls) {
   var tag = W.tag("div", "class-item", "." + cls);
   tag.attr("name", cls);
   this.classesElem.add(tag);
   tag.eadd("click", XE.ClassClick);
}

XmlEditor.ClassClick = function(){
    var name = this.attr("name");
    var elem = this.findParent(".element");
    elem.linked.rcs(name);
    this.del();
  }
    
XmlEditor.IdClick = function(){
    var elem = this.findParent(".element");
    elem.linked.id = null;
    elem.linked.ratt("id");
    this.attr("name", "");
    this.clear();
  }

XmlEditor.SynchronizeAttr = function(element) {
   this.attrElem.clear();
   for (var index = 0; index < element.attributes.length; index++) {
      var val = element.attributes[index];
      
     if (val.name != "class" && val.name != "id" ){
        this.AddAttribute(val.name, val.value);
     }
   }
}
  
XmlEditor.AddAttribute = function(name, value) {
   var attr = this.attrElem.adv("attribute");
   attr.aname = name;
   attr.linked = this.linked;
   attr.attr("name", name);
   attr.nameElem = attr.adv("aname", name);
   attr.add(" = ");
   attr.valElem = attr.adv("avalue");
    if (attr.valElem.innerText != undefined){
     attr.valElem.innerText = value;
    }
  else
  {
    attr.valElem.textContent = value;
  }
   attr.nameElem.onclick = XE.AttrNameClick;
   attr.onclick = XE.AttrValClick;
}
  
  
XmlEditor.AttrNameClick = function(){
    var elem = this.findParent(".element");
    var attr = this.findParent(".attribute");
    elem.linked.removeAttribute(attr.aname);
    attr.del();
  }
  
XmlEditor.AttrValClick = function(){
    var elem = this.findParent(".element");
    this.cls("editing");   
    if (this.valElem.innerHTML.length <= 0){
      this.valElem.innerHTML = "_";
    }
    this.valElem.contentEditable = true;
    this.valElem.focus();  
    this.valElem.onblur = XE.EndElementEditing;
} 
  

XmlEditor.ValueClick = function(){
    var elem = this.findParent(".element");
    this.cls("editing");  
    this.attr("contenteditable","true");
    this.onblur = XE.EndElementEditing;
}
  
XmlEditor.EndElementEditing = function(){
    var elem = this.findParent(".element");
   var evalues = elem.findAll(".value.editing");
            for (var i = 0; i < evalues.length; i++) {
              var val = evalues[i];
              val.rcs("editing");  
              val.linkedNode.value = this.html();
              val.ratt("contenteditable");
            }
  var avalues = elem.findAll(".attribute.editing");
            for (var i = 0; i < avalues.length; i++) {
              var att = avalues[i];
              att.rcs("editing");  
              att.linked.attr(att.aname, att.valElem.html());
              att.valElem.ratt("contenteditable");
            }
}
      
XmlEditor.WrapContent = function(content) {
     XE.Source.html(content);
     for (var i = 0; i < XE.Source.childNodes.length; i++){
        XE.Content.add(XE.WrapNode(XE.Source.childNodes[i]));
     }
     //XE.RefreshTags();
},
        
XmlEditor.WrapNode = function(element, parent) {
        switch (element.nodeType){
          case 3:
            var value = element.nodeValue;
            var elem = W.tag("div", "value", value);
            elem.onclick = XE.ValueClick;
            elem.linkedNode = element;
            var linefeed = elem.innerHTML.replace(/ /g, "");
            if (linefeed == "\n" || linefeed == "\r" || linefeed == "\r\n" || linefeed == "\n\r") {
              elem.cls("linebreak");
            }
            if (element.parentNode != null) {
              if (element.parentNode.tagName == "SCRIPT") {
                elem.innerHTML = value;
              }
              return elem;
            }
            return element;
          case 7:
            element = element.nodeValue;
            return element;
          case 9:
            element = element.documentElement;
          default:
            var welem = this.GetNewElem(element);
            welem.Synchronize(element);
            if (element.sname == "style") {
                XE.WrapStyles(welem, element);
                return welem;
            }
	    if (element.sname == "code") {
                XE.WrapCode(welem, element);
                return welem;
            }
            for (var i = 0; i < element.childNodes.length; i++){
               welem.innerNodes.add(XE.WrapNode(element.childNodes[i]));
            }
            return welem;
        }
        return element;
      },
         
XmlEditor.WrapStyles = function(syselem, elem) {
   	    var txt = elem.html();
  	    var val = syselem.innerNodes;
            var styles = txt.match(/[^{]+\{[^}]+\}/g);
            for (var i = 0; i < styles.length; i++) {
                var st = styles[i];
                var css = val.adv("css");
                var iBod = st.indexOf('{');
                var bod = st.substr(iBod);
                var sl = st.substring(0, iBod);
                sl = sl.match(/[.#:\s]?[A-Za-z\-_0-9]+,?/g);
                if (sl == null) {
                    continue;
                }
                for (var j = 0; j < sl.length; j++) {
                    var sel = css.adv('selector',sl[j]);
                  if (sl[j].start("#")){
                    sel.cls("id"); 
                  }
                  if (sl[j].start(".")){
                    sel.cls("class"); 
                  }
                  if (sl[j].start(":")){
                    sel.cls("meta"); 
                  }
                }
                //css.adv("clear");
                css.add("{");
                var body = css.adv('body');
                var maket = body.adv("maket");
                maket.adv("inner", "TEXT");
                sl = bod.match(/([A-Za-z\-_]+)\s*:\s*([^;]+)/g);
                if (sl == null) {
                    continue;
                }
                for (var j = 0; j < sl.length; j++) {
                    var it = sl[j].split(':');
                    var prop = body.adv('prop');
                    prop.adv('name', it[0]);
                    prop.add(':');
                    prop.adv('val',it[1]);
                    prop.add(';');
                  if (it[0] == "color"){
                    maket.style.color = it[1];
                  }
                  if (it[0] == "background-color"){
                    maket.style.backgroundColor = it[1];
                  }
                  if (it[0] == "border-color"){
                    maket.style.borderColor = it[1];
                  }
                  if (it[0] == "border"){
                    maket.style.border = it[1];
                  }
                  if (it[0] == "background"){
                    maket.style.background = it[1];
                  }
                  if (it[0] == "font-weight"){
                    maket.style.fontWeight = it[1];
                  }                  
                  if (it[0] == "font-size"){
                    maket.style.fontSize = it[1];
                  }
                  if (it[0] == "padding"){
                    maket.style.padding = it[1];
                  }                  
                  if (it[0] == "padding-top"){
                    maket.style.paddingTop = it[1];
                  }                                    
                  if (it[0] == "padding-left"){
                    maket.style.paddingLeft = it[1];
                  }
                  if (it[0] == "padding-right"){
                    maket.style.paddingRight = it[1];
                  }
                  if (it[0] == "padding-bottom"){
                    maket.style.paddingBottom = it[1];
                  }
                }
                css.add("}");
            }
        }
    
    XmlEditor.WrapCode = function(syselem, elem) {
	var txt = elem.text();
	var val = syselem.innerNodes;
	var styles = txt.match(/[^{]+\{[^}]+\}/g);
	for (var i = 0; i < styles.length; i++) {
	    var st = styles[i];
	    var css = val.adv("css");
	    var iBod = st.indexOf('{');
	    var bod = st.substr(iBod);
	    var sl = st.substring(0, iBod);
	    sl = sl.match(/[.#:\s]?[A-Za-z\-_0-9]+,?/g);
	    if (sl == null) {
		continue;
		    }
	    for (var j = 0; j < sl.length; j++) {
		var sel = css.adv('selector',sl[j]);
		if (sl[j].start("#")){
                    sel.cls("id"); 
                  }
		    if (sl[j].start(".")){
			sel.cls("class"); 
		    }
		    if (sl[j].start(":")){
			sel.cls("meta"); 
		    }
                }
                //css.adv("clear");
                css.add("{");
                var body = css.adv('body');
                var maket = body.adv("maket");
                maket.adv("inner", "TEXT");
                sl = bod.match(/([A-Za-z\-_]+)\s*:\s*([^;]+)/g);
                if (sl == null) {
                    continue;
			}
                for (var j = 0; j < sl.length; j++) {
                    var it = sl[j].split(':');
                    var prop = body.adv('prop');
                    prop.adv('name', it[0]);
                    prop.add(':');
                    prop.adv('val',it[1]);
                    prop.add(';');
		    if (it[0] == "color"){
			maket.style.color = it[1];
		    }
		    if (it[0] == "background-color"){
			maket.style.backgroundColor = it[1];
		    }
		    if (it[0] == "border-color"){
			maket.style.borderColor = it[1];
		    }
		    if (it[0] == "border"){
			maket.style.border = it[1];
		    }
		    if (it[0] == "background"){
			maket.style.background = it[1];
		    }
		    if (it[0] == "font-weight"){
			maket.style.fontWeight = it[1];
		    }                  
		    if (it[0] == "font-size"){
			maket.style.fontSize = it[1];
		    }
		    if (it[0] == "padding"){
			maket.style.padding = it[1];
		    }                  
		    if (it[0] == "padding-top"){
			maket.style.paddingTop = it[1];
		    }                                    
		    if (it[0] == "padding-left"){
			maket.style.paddingLeft = it[1];
		    }
		    if (it[0] == "padding-right"){
			maket.style.paddingRight = it[1];
		    }
		    if (it[0] == "padding-bottom"){
			maket.style.paddingBottom = it[1];
		    }
                }
                css.add("}");
            }
    }
      

XmlEditor.ShowCss = function(event) {
            var item = XmlEditor.Content.get(".current");
            CssInfo.Show(item.linked);
            event.preventDefault();
      },      
      
XmlEditor.ShowMenu = function(event){
        var item = this.findParent("element");
        var wm = XmlEditor.Content.get(".withmenu");
        if (wm != null) wm.rcs("withmenu");
        item.cls("withmenu");
        XmlEditor.Menu.Show(item);
      },
        
XmlEditor.BindEvents = function(elem)
      {        
        Drag.MakeDraggable(this, "self");
        Drag.MakeReceiver(this, ".element, .element-prototype");
        this.cls("no-body-drop");
        this.objectReceived = XE.ElementDropped;
        this.onclick = XE.SelectElement;
        this.nameElem.ondblclick = XE.ShowEditor;
        this.onmouseover = XE.ElementHover;
        this.onmouseout = XE.ElementOut;
	this.SetCurrent = XE.ElementHover;
	this.ResetCurrent = XE.ElementOut;
        this.indicator.onclick = XE.ShowHideElement;
        //this.nameElem.onclick = XE.SelectElementByName;
      },
        
XmlEditor.ElementDropped = function(elem){
  if (elem.has("element")){
    if (this == elem || this.isChildOf(elem)){
      return false;
    }
    this.innerNodes.add(elem);
    this.linked.add(elem.linked);
    return;
  }
  if (elem.has("element-prototype")){
    elem.rcs("element-prototype");
    this.linked.add(elem);
    var welem = XE.GetNewElem(elem);
    welem.Synchronize(elem);
    this.innerNodes.add(welem);
  }
}
      
XmlEditor.GetSelection = function() {
            var selected = XmlEditor.Content.findAll(".selected");
            return selected;
        },
      
XmlEditor.RemoveSelection = function() {
            XE.Content.findAll(".selected").rcs("selected");
        },
          
 XmlEditor.SelectElement = function(event) {
  	    this.findAll(".selected").rcs("selected");
            this.findParents(".selected").rcs("selected");
            this.toggle("selected");
            event.stopPropagation();
        },

XmlEditor.SelectElementByName = function(event) {
            var item = this.findParent(".element");
            /*if (item != null){
              item.findParent(".selected").removeClass("selected");
              item.addClass("selected");
              event.preventDefault();
              return;
            }*/
  	    item.findAll(".selected").rcs("selected");
            item.findParents(".selected").rcs("selected");
            item.toggle("selected");
            event.preventDefault();
        },

XmlEditor.ShowHideElement = function(event) {
            var element = this.findParent(".element");
	    if (element.has("hided")){
              element.indicator.html("");
              element.rcs("hided");              
            }  
            else{
              element.indicator.html("+");
              element.cls("hided");
            }
            event.stopPropagation();
},

XmlEditor.ShowAttributes= function() {
            XmlEditor.Content.findAll(".attributes").toggle();
            return false;
        },

XmlEditor.ShowEditor= function() {
            XE.ElementEditor.Show(this.findParent(".element"));
        },

XmlEditor.ElementHover= function(event) {
  	    var wm = XE.Content.get(".withmenu");
   	    if (wm != null) wm.rcs("withmenu");
  	    this.cls("withmenu");
  
            XmlEditor.Menu.Show(this);
	    var over = XE.Content.findAll(".over");
  for (var i = 0; i < over.length; i++){
   over[i].rcs("over"); 
  }	  
            this.cls("over");
  	    var parent = this.findParent(".element");
            while (parent != null){
               parent.cls("over");
               parent = parent.findParent(".element");
            }
  	    var current = XE.Content.get(".current");
  if (current != null){
   current.rcs("current"); 
  }
            this.cls("current");  
  	    event.cancelBubble = true;
},


XmlEditor.ElementOut= function() {
  
	},


XmlEditor.FilterByClass= function(event) {
            var sel = XE.GetSelection();
            var cls = this.attr("name");
            for (var i = 0; i < sel.length; i++) {
              if (!sel[i].linked.has(cls)){
              	sel[i].linked.cls(cls);
                sel[i].AddClass(cls);
              }
            } 
        },

XmlEditor.FilterByTag= function(event) {
            var sel = XE.GetSelection();
            
        },

XmlEditor.FilterById= function(event) {
            var sel = XE.GetSelection();
            var сls = this.attr("name");
            for (var i = 0; i < sel.length; i++) {
	      sel[i].linked.id = сls;
              sel[i].identifierElem.html("#" + сls);
              sel[i].identifierElem.attr("name", сls);
            } 
        },


XmlEditor.SetEditable= function(isEditable) {
            this.Editable = isEditable;
            if (isEditable) {
                $(this.Editor).addClass("editable");
                $(".current", this.Content).removeClass("current");
                $("element:first", this.Content).addClass("current");
            }
            else {
                $(this.Editor).removeClass("editable");
            }
        },

XmlEditor.NextTag= function() {
            var current = $(".current:first", this.Content);
            if (current.length > 0) {
                var next = current.nextAll("element");
                if (next.length > 0) {
                    current.removeClass("current");
                    $(next[0]).addClass("current");
                }
            }
        },

XmlEditor.PrevTag= function() {
            var current = $(".current:first", this.Content);
            if (current.length > 0) {
                var prev = current.prevAll("element");
                if (prev.length > 0) {
                    current.removeClass("current");
                    $(prev[0]).addClass("current");
                }
            }
        },
          
XmlEditor.InnerTag= function() {
            var current = $(".current:first", this.Content);
            if (current.length > 0) {
                var inner = $(">element:first", current);
                if (inner.length > 0) {
                    current.removeClass("current");
                    inner.addClass("current");
                }
            }
        },

XmlEditor.OuterTag= function(fileName) {
            var current = $(".current:first", this.Content);
            if (current.length > 0) {
                var parent = current.parent();
                if (parent.length > 0) {
                    current.removeClass("current");
                    if (parent[0].tagName == "ELEMENT") {
                        parent.addClass("current");
                    }
                }
            }
        },

XmlEditor.ElementEditor = XE.EE =  {
            Element: null,

            Init: function() {
		XE.EE.Element = W.get(".element-editor");
                XE.EE.Element.NameField = XE.EE.Element.get(".name");
                XE.EE.Element.IdField = XE.EE.Element.get(".id");
                XE.EE.Element.ClassesField = XE.EE.Element.get(".classes");
                XE.EE.Element.AttrField = XE.EE.Element.get(".attributes");
                XE.EE.Element.ValueField = XE.EE.Element.get(".values");
            },

            Show: function(elem) {
              	//if (XE.EE.EditedElement != null) return;
                elem.cls("editing");
                XE.EE.EditedElement = elem;
                XE.EE.Element.NameField.html(elem.attr("name"));
                XE.EE.Element.IdField.html(elem.identifierElem.html());
		XE.EE.Element.ClassesField.html(elem.classesElem.html());
      		XE.EE.Element.AttrField.html(elem.attrElem.html());
              	XE.EE.Element.ValueField.clear();
              	var vals = elem.innerNodes.childs(".value");
                for (var i = 0; i < vals.length; i++) {
                 var div = XE.EE.Element.ValueField.adv("value", vals[i].html());
                  div.attr("content-editable", "true");
                }
                var win = XE.EE.Element.findParent(".window");
                win.show();
                win.onclose = XE.EE.Close;
                return false;
            },

            Apply: function() {
                var newTagName = this.TagEditor.value;
                $(">firsttag", this.EditedElement).html("&lt;" + newTagName + "&gt;");
                $(">lasttag", this.EditedElement).html("&lt;/" + newTagName + "&gt;");
                var valueElements = $(">value", this.EditedElement);
                for (var i = 0; i < valueElements.length; i++) {
                    var newValue = $("textarea", valueElements[i]).val();
                    valueElements[i].innerHTML = newValue;
                }

                var attrElements = $(">attribute", this.EditedElement);
                for (var i = 0; i < attrElements.length; i++) {
                    var newValue = $("input", attrElements[i]).val();
                    attrElements[i].innerHTML = newValue;
                }

                this.EditedElement.id = newTagName;
                $(this.EditedElement).removeClass("editing");
                this.Active = false;
            },

            Close: function() {
                XE.EE.EditedElement.rcs("editing");
                XE.EE.EditedElement = null;
            },

            KeyHandler: function(event) {
                switch (event.keyCode) {
                    case 27:
                        this.Close();
                        break;
                    default: return;
                }
                return false;
            }
        },

XmlEditor.Menu= {
            Element : null,

            Init: function() {
		XE.Menu.Element = XE.Editor.get(".element-menu");               
            },
          
          
            Park: function() {
                 XmlEditor.Menu.Element.style.top = "80px";
                XmlEditor.Menu.Element.style.left = "0px";
            },

            GetSelection: function() {
                this.LastElement = $(".current:first", XmlEditor.Content);
                this.SelectedElements = $(".current", XmlEditor.Content);
            },

            Show: function(elem){
                XmlEditor.Menu.Element.style.top = elem.offsetTop + "px";
                XmlEditor.Menu.Element.style.left = (elem.offsetLeft - XmlEditor.Menu.Element.offsetWidth) + "px";
            },

            Wrap: function() {
                var newTag = document.createElement("tag");
                $(this.SelectedElements).removeClass("current");
                $(this.SelectedElements).wrapAll(newTag);
                var parent = $(this.LastElement).parent();
                XmlEditor.WrapElement(parent[0]);
                parent.addClass("current");
                this.Close();
            },

            Insert: function() {
                var newTag = document.createElement("tag");
                XmlEditor.WrapElement(newTag);
                $(">LastTag", this.LastElement).before(newTag);
                this.Close();
            },

            Edit: function() {
                this.Close();
                XmlEditor.ElementEditor.Show();
            },

            Delete: function() {
                var elem = XmlEditor.Content.get(".current");
              if (elem != null){
                    if (elem.linked != null) {
                        elem.linked.del();
                    }
              	    elem.del();
                }
   		XE.Menu.Park();
            },
  
  DeleteSelected: function() {
                var elements = XmlEditor.Content.findAll(".selected");
                for (var i = 0; i < elements.length; i++) {
                    if (elements[i].linked != null) {
                        elements[i].linked.del();
                    }
                    elements[i].del();
                }
            },

            Close: function() {
                this.Active = false;
                this.MenuItem.hide();
            },

            ClickEventHandler: function() {
                var name = this.id;
                XmlEditor.Menu[name]();
            },

            KeyHandler: function(event) {
                this.GetSelection();
                switch (event.keyCode) {
                    case 27: this.Close(); break;
                    case 87: this.Wrap(); break;
                    case 68: this.Delete(); break;
                    case 90: this.Edit(); break;
                    case 81: this.Insert(); break;
                    default: return;
                }
                return false;
            }
        };
    
    XmlEditor.Navigator = XE.Nav =  {
	
	Init: function() {
	    window.onkeypress = XE.Nav.KeyHandler;
	},
	
	KeyHandler: function(event) {
	    switch (event.keyCode) {
		case 40:
		    var current = W.get(".withmenu");
		    if (current != null){
			var next = current.nextSibling;
			next.SetCurrent();
		    }
		    break;//Вниз
		case 38: 
		    break;//Вверх
		case 39: 
		    break;//Вправо
		case 37: 
		    break;//Влево
			default: return false;   
	    }
	    return false; 
	}
    };
  
    </script>

</module>
