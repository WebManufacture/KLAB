<div id="designer-block" class="content  ui-desktop"  url="System.Designer.htm">
<subscribe class='jasp-message' ui-event-id="designer-block" ui-event-type="onclick" target="#designer-block"></subscribe>
<ajax class='jasp-message' urlbase="proxy" url='System.Designer.MiniMenu.htm' append="#MRT_IS_SiteFabric-MainDiv" ></ajax>
<eval class='jasp-message jasp-handler ui-menu-handler' event-id="msg_Designer_LOADING">
    $("#cssPalette").draggable();
    $("#cssPalette").resizable();
    $("#cssPalette .css-cell").draggable({ revert: true, helper: 'clone' });
    
    
    $("#classesPalette").draggable();
    $("#classesPalette").resizable();
    $("#classesPalette .class-cell").draggable({ revert: true, helper: 'clone' });
     
    
    
    designer_frame = document.createElement("iframe");
    designer_frame.setAttribute("src", GetServerRoot() + "System.Empty.htm");
    document.body.appendChild(designer_frame);
    $(designer_frame).hide();
    $("#designer-block")[0].ondragover = UiItemDragOver;
    $("#designer-block")[0].ondrop = UiItemDrop;
    $("#designer-block").droppable({ accept: ".ui-item", activeClass: "command-wait", hoverClass: "command-accept", drop: UiItemDrop});
    $("#designer-block").append($("#log_window"));
    $("#log_window").hide();
  
    $("#designer-block").show();
    $("#content-block").show();
    SetSelectionMode("vualizer");
  </eval>
  
<script type="text/javascript">
  var SelectionMode = "none";
  var CurrentElement = null;
  var designer_frame = null;
  
   function ShowDesigner()
  {
    $(".ui-block").hide();
     $("#designer-block").show();
    $("#content-block").show();
    SetSelectionMode("vualizer");
  }
  
  function CreatePrevieWindow(id,  content)
  {
    var html = '<div id="'+id+'" class="palette system-block"><div class="header"><span class="name"></span></div>'+content+'</div>';
    $(document.body).append(html);
    var elem = $("#" + id);
    elem.draggable({handle:".header"});
    $(".header", elem).dblclick(function(){$(this).parent().remove();});
    return elem;
  }
  
  
  function ReloadDesigner()
  {
    
    //var fileName = $("storage .current-file .file-name").html();
    
    //$("#content-block").attr("url", GetSimpleHandler(fileName));
    $$.ReloadContent("#content-block");
    //designer_frame.location.reload();
    //ShowDesigner();
  }
  
  function ReLoadDesignerModule()
  {
    ReloadDesigner();
    return;
    var header = document.getElementsByTagName("head")[0];
    for(var i =0; i < header.children.length; i++)
    {
      if (header.children[i].getAttribute("class") == "ajax-loaded"){
        header.removeChild(header.children[i]);
      } 
    }
    $$.ReloadContent("#MRT_IS_SiteFabric-MainDiv"); 
  }
  
  function UiItemDrop(event, ui)
  {
    if (event.dataTransfer != undefined)
    {
      var data = event.dataTransfer.getData("text/plain");
      event.preventDefault();
    }
    else
    {
      var data = ui.draggable;
    }
    var file = $(data);
    
    var name = file.attr("name");
    var path = file.attr("path") + "/" + name ;
    
    if (file.hasClass("htm") || file.hasClass("html"))
    {
      var pos = file.position();
      XmlEditor.Editor.css("top", pos.top);
      XmlEditor.Editor.css("left", pos.left);
      XmlEditor.Load(GetSimpleHandler(path));
      return;
    }
 
        
        var id = "win_" + file.attr("id");
      var doc = document.getElementById(id);
      if (doc != null)
      {
        $(doc).show();
        return;
          }
          
        var div = CreatePrevieWindow(id, "");
        div.css("top", event.screenY+"px");
        div.css("left", event.screenX+"px");
        $(".header .name",div).html(file.attr("name"));
        
        designer_frame.loadingObject = {
          div : div,
          file : file,
          name : name,
          path : path,
          id : id
        }

       
    if (file.hasClass("wdg"))
    {
          ContentGet(name, WidgetReady);
          //ContentMessageGet(name, "DesktopManager");
       return;
    }
          
      if (file.hasClass("Image"))
      {
        div.append("<img class='thumbnail' src='" + path + "'/>");
        div.show();
      }
      if (file.hasClass("css"))
      {
        $(designer_frame.contentDocument.documentElement).empty();
        
        designer_frame.loadingObject.container = designer_frame.contentDocument.createElement("style");
        designer_frame.loadingObject.container.setAttribute("type", "text/css")  
          designer_frame.contentDocument.documentElement.appendChild(designer_frame.loadingObject.container);
        ContentGet(name, CssContentReady);
      }
      

      
    }
    
    function WidgetReady(event)
    {  
      designer_frame.loadingObject.div.append(this.responseText);
      var initializer = $("initializer", designer_frame.loadingObject.div).html();
      designer_frame.loadingObject.div[0].Initializer = window[initializer];
      designer_frame.loadingObject.div[0].Initializer();
      designer_frame.loadingObject.div.show();
    }
    
    function CssContentReady(event)
    {
      var loadingObject = designer_frame.loadingObject;
      $(loadingObject.container).html(this.responseText);
      var styleSheet = designer_frame.contentDocument.styleSheets[0];
      for(var i =0; i < styleSheet.cssRules.length; i++)
      {
        var rule = styleSheet.cssRules[i];
        
        var html = "<div class='css-style' selector='" + rule.selectorText + "'>"+
            "<selector>" + rule.selectorText + "</selector>";
        for(var j =0; j < rule.style.length; j++)
          
        {
          var key = rule.style[j];
          var value = rule.style.getPropertyValue(key);
          html += "<rule class='css-rule' name='" + key + "' value='" + value + "'>" + key + ":" + value + "</rule >";
        }
        html += "</div>";
        loadingObject.div.append(html);
      }
      loadingObject.div.show();
    }
    
    function UiItemDragOver(event)
    {
      var isLink = event.dataTransfer.types.contains("text/plain");
      //isLink &= $(event.dataTransfer.value).hasClass("ui-item");
      if (isLink){
        event.preventDefault();
      }
      //return isLink;
    }
    
    
    
    function ShowColors()
    {
      $("#colorPalette").show();
      
    }
    
    function ShowClassesPalette()
    {
      $("#classesPalette").show();
      
    }
    
    function ShowCssPalette()
    {
      $("#cssPalette").show();
    }
    
    function ColorSelected()
    {
      var element = $("#content-block .construction-element");
      element.css("background-color", $(this).css("background-color"));
    }
    
    function CreateDiv() {
      div = $("#designer-block prototypes .construction-element").clone();
      $("#designer-block").append(div);
      div.find(".color-place").droppable({
        accept: '.color-cell',
        activeClass: 'color-place-active',
        hoverClass: 'color-place-hover',
        drop: DesignerColorDropped
      });
      div.find(".css-place").droppable({
        accept: '.css-cell',
        activeClass: 'css-place-active',
        hoverClass: 'css-place-hover',
        drop: DesignerCssDropped
      });
      div.find(".classes-place").droppable({
        accept: '.class-cell',
        activeClass: 'classes-place-active',
        hoverClass: 'classes-place-hover',
        drop: DesignerClassDropped
      });
      $(div).draggable();
      $(div).resizable();
    }
    
    function DesignerColorDropped(event, ui) {
      if ($(this).hasClass("bg-color-place"))
      {
        $(this).parent().css("background-color", ui.helper.css("background-color"));
      }
      if ($(this).hasClass("border-color-place"))
      {
        $(this).parent().css("border", "solid 1px " + ui.helper.css("background-color"));
      }
    }
    
    
    function DesignerCssDropped(event, ui) {
      $(this).append("<div class='css-item' property='" + ui.helper.attr("property") + "' value='" + ui.helper.attr("value") + "'>" + ui.helper.html() + "</div>");
    }
    
    function DesignerClassDropped(event, ui) {
      $(this).append("<div class='class-item'>" + ui.helper.html() + "</div>");
    }
    
    
    function DesignerToDiv() {
      var element = $("#designer-block>.construction-element");
      if (element.length <= 0) return;
        if (element[0].linkedElement == undefined)
        {
        div = document.createElement("div");
      div = $(div);
      div.width(element.width());
      div.height(element.height());
      div.css("background-color", element.css("background-color"));
      div.css("border", element.css("border"));
      var cssprops = element.find(".css-item");
      for (var i=0; i<cssprops.length; i++)
      {
        div.css(cssprops[i].getAttribute("property"), cssprops[i].getAttribute("value"));
      }
      var classes = element.find(".class-item");
      for (var i=0; i<classes.length; i++)
      {
        div.addClass(classes[i].innerHtml);
      }
      $("#content-block").append(div);
      element.remove();
    }
    else
    {
      
    }
    
  }
  
  function DesignerCropImage() {
    var selection = $("#designer-block>.construction-element");
    var background = $("body").attr("background-image");
    var left = parseInt(selection.css("left").replace("px", ""));
    var top = parseInt(selection.css("top").replace("px", ""));
    var width = parseInt(selection.css("width").replace("px", ""));
    var height = parseInt(selection.css("height").replace("px", ""));

    var background_pos = $("body").css("background-position").split(" ");
    alert(background_pos);
    var background_x = parseInt(background_pos[0].replace("px", ""));
    var background_y = parseInt(background_pos[1].replace("px", ""));
     
     alert("background_x " +background_x+ " background_y " + background_y);
    left = left-background_x;
    top = top-background_y;
    
    alert("left " +left  + " top " + top );
    var requestUrl = "System.ImagesHandler.ashx?crop=" + escape(background) + "&left=" + left + "&top=" + top + "&width=" + width + "&height=" + height;
    var request = new XMLHttpRequest();
    request.selection = selection;
    request.onload = CropedImageLoaded;
    request.open("GET", requestUrl);
    request.send(null);
  }
  
  
  function CropedImageLoaded(result) {
    alert(this.responseText);
    this.selection.css("background-image", "url('" + this.responseText + "')");
  }
  
  function SetSelectionMode(mode) {
  $("#designer-block").removeClass("info-mode");
    $("#designer-block").removeClass("vualizer");
    $("#designer-block .tag-info").hide();
    $("#designer-block .vertical-line").hide();
    $("#designer-block .horisontal-line").hide();
    $(document).unbind("mousemove", DesignerMouseMove);
    $(document).unbind("mousedown", DesignerMouseDown);
    CurrentElement = null;
    if (mode == "info") {
      $("#designer-block").addClass("info-mode");
      $("#designer-block .css-info").show();
      //$("#designer-block .tag-info").show();
      $("#designer-block .vertical-line").show();
      $("#designer-block .horisontal-line").show();
      $(document).bind("mousemove", DesignerMouseMove);
      $(document).bind("mousedown", DesignerMouseDown);
    }
    if (mode == "vualizer") {
      $("#designer-block").addClass("vualizer");
    } 
    SelectionMode = mode;
  }
  
  function DesignerDeleteSelected()
  {
    $("#designer-block>.construction-element").remove();
  }
  
  function UnSelectAll() {
    $("#content-block .selected").removeClass("selected");
  }
  
  function SelectElement(elem) {
    if ($(elem).hasClass("vertical-line") ||
        $(elem).hasClass("horizontal-line"))
    return;
    $(elem).toggleClass(".MRT_IS_OSC-selected");
    ShowCssInfo(elem);
  }
  
  function MouseDoubleDown(event) {
    XmlEditor.Show(event.target);
  }
  
  function DesignerMouseMove(event) {
    if (SelectionMode == "info") {
      $("#designer-block .vertical-line").css("left", event.clientX + 2);
      $("#designer-block .horisontal-line").css("top", event.clientY + 2);
      //$("#designer-block .tag-info").css("left", event.clientX + 2);
      //$("#designer-block .tag-info").css("top", event.clientY + 2);
      
      var element = event.target;
      if (element != CurrentElement && !$(element ).hasClass("vertical-line") && 
        !$(element).hasClass("horizontal-line"))
      {
        if (CurrentElement != null)
        {
          $(CurrentElement).removeClass(".MRT_IS_OSC-current");
        }
        CurrentElement = element;
        $(CurrentElement).addClass(".MRT_IS_OSC-current");
      }
      
      var info = "";
      info += "<mouse-x>X: " + event.clientX + " px</mouse-x>";
      info += "<mouse-y>Y: " + event.clientY + " px</mouse-y>";
      info += "<mouse-Page-x>Page-X: " + event.pageX + " px</mouse-Page-x>";
      info += "<mouse-Page-y>Page-Y: " + event.pageY + " px</mouse-Page-y>";
      
      $(".css-info .mouse-info").html(info);
    }
  }
  
  function DesignerMouseDown(event) {
    if (event.button == 2 && SelectionMode == "info")  
    {
      SelectElement(event.target);
      return false;
    }
  }
 
</script>


<style type="text/css">
  #designer-block
  { 
     background-color:rgba(0, 0, 0, 0.5);
     border:1px solid black;
     height:0px;
     width:0px;
   position: absolute;
   top: 0;
     left: 0;
     z-index:10; 
  }
  
  #designer-block.info-mode
  {
    width: 0px;
    height: 0px;
  }
  
  #designer-block.fullsize
  {
    width: 99%;
    height: 99%;
  }
  
  #designer-block.vualizer
  {
    width: 99.8%;
    height: 99.8%;
    background-color: rgba(0,0,0,0.4);
  }
  
  #designer-block:-moz-drag-over {
    rgba(0,0,0,0.8);
  }
  
  #designer-block .system-block
  {
    position: fixed;
  }
  
  #designer-block .horisontal-line
  {
    top: 100px;
    left: 0px;
    width: 100%;
    border-top: solid 1px red;
    height: 2px;
    background: white;
    opacity: 0.7;
    display: none;
  }
  
  #designer-block .vertical-line
  {
    top: 0px;
    left: 100px;
    height: 100%;
    border-left: solid 1px red;
    width: 2px;
    background: white;
    opacity: 0.7;
    display: none;
  }
  
  #designer-block designer-menu #btnClose
  {
    position: absolute;
    right: 0px;
    top: 0px;
  }
  
  #designer-block .tag-info
  {
    top: 100px;
    left: 100px;
    width: 200px;
    height: 200px;
    overflow: hidden;
    padding: 10px;
    color: Black;
    background: white;
    opacity: 0.7;
    display: none;
  }
  
  #designer-block .tag-info *
  {
    display: block;
  }
  
  #designer-block .tag-info tag
  {
    font-weight: bold;
    display: block;
  }
  
  #designer-block .tag-info addition
  {
    display: block;
    color: Blue;
  }
  
  
  #designer-block .image-preview 
  {
    top: 20px;
    left: 20px;
    width: 400px;
    height: 400px;
  }
  
  
  .palette
  {
    font-family: verdana;
    font-size: 12px;
    position:fixed;
    z-index: 10;
    opacity: .9;
    top: 100px;
    right: 100px;
    background-image:url(data:image/gif;base64,R0lGODlhAwADAIAAANve4f/7/yH5BAAAAAAALAAAAAADAAMAAAIETHAZBQA7);
    border: solid 1px gray;
    border-radius: 10px;
    -moz-border-radius: 10px;
    width: 300px;
    height: 260px;
    padding-top: 40px;
    display: none;
    overflow: hidden;
    margin-bottom: 30px;
  }
  
  
  .palette .status-box
  {
    background-color: none;
    opacity: 0.7;
    border-top: solid 1px gray;
    width: 100%;
    height: 25px;
    text-align: center;
    cursor: default;
    padding-top: 4px;
    position: absolute;
    bottom: 0px;
    left: 0px;
    color: navy;
  }
  
  
  
  .palette .header
  {
    background-color: orange;
    border: solid 1px darkorange;
    border-radius: 5px;
    -moz-border-radius: 5px;
    font-size: 16px;
    width: 80%;
    height: 25px;
    margin-left: 10%;
    margin-right: 10%;
    top: 6px;
    text-align: center;
    cursor: default;
    padding-top: 4px;
    position: absolute;
  }
  
  
  .palette .drop-place
  {
    background-color: white;
    border: solid 1px darkorange;
    border-radius: 5px;
    -moz-border-radius: 5px;
    width: 96%;
    margin-left: 2%;
    margin-right: 2%;
    height: 96%;
    text-align: center;
    float:left;
    margin: 2px;
    padding-top: 4px;
    text-align: center;
  }
  
  #MRT-IS-OSC-faveletDiv .drop-place.image-drag-active
  {
    background-color: #99CCFF;
  }
  
  #MRT-IS-OSC-faveletDiv .drop-place.image-drag-accept
  {
    background-color: #33CC00;
  }
  
  /*.ui-draggable-dragging
  {
    z-index: 11;
    position: fixed!important;
  }*/
    
    #MRT-IS-OSC-faveletDiv .header:hover
      {
      background-color: #FFCC33; 
  }
  
  #MRT-IS-OSC-faveletDiv .header .close-button
  {
    position: absolute;
    top: 1px;
    right: 2px;
    width: 24px;
    height: 24px;
    float: right;
    background: url("http://79.171.127.237:8008/Bookmarklets/gtk-close.png") no-repeat;
  }
  
  #MRT-IS-OSC-faveletDiv .header .close-button:hover
  {
    border: dotted 1px gray; 
  }
  
  
    #designer-block #cssPalette .css-cell{
    float:left;
    height: 20px
      border-radius: 4px;
    -moz-border-radius: 4px;
    border: solid 1px gray;
    margin: 2px;
  }
  
  #designer-block #classesPalette .class-cell{
    float:left;
    height: 20px
      border-radius: 4px;
    -moz-border-radius: 4px;
    border: solid 1px gray;
    margin: 2px;
  }
  
   
  #content-block div.designer-tracked
  {
    position: absolute;
    border: solid 1px black;
    z-index: 20;
  }
  
  
  #designer-block .construction-element
  {
    position: absolute;
    background: white;
    border: dotted 1px navy;
    opacity: .6;
    top: 100px;
    left: 300px;
    width: 100px;
    height: 100px;
  }
  
  #designer-block .construction-element selection-menu
  {
    margin-top: -45px;
    display: block;
    opacity: 1;
  }
  
  
  #content-block div.construction-element:hover
  {
    border: dotted 1px blue;
    opacity: 1;
  }
  
  
  #designer-block .construction-element .place
  {
    border:1px solid gray;
    height:40px;
    width:40px;
    float: left;
    -moz-border-radius: 7px;
    border-radius: 7px;
  }
  
  
  #designer-block .construction-element .color-place-active
  {
    background-color: yellow;
  }
  
  #designer-block .construction-element .color-place-hover
  {
    background-color: orange;
  }
  
  
  #designer-block .construction-element .css-place-active
  {
    background-color: violet;
  }
  
  #designer-block .construction-element .css-place-hover
  {
    background-color: navy;
  }
  
  
  #designer-block .construction-element .classes-place-active
  {
    background-color: rgb(100, 255, 200);
  }
  
  #designer-block .construction-element .classes-place-hover
  {
    background-color: green;
  }
  
    .ui-resizable { position: relative;}
  .ui-resizable-handle { position: absolute;font-size: 0.1px;z-index: 99999; display: block;}
  .ui-resizable-disabled .ui-resizable-handle, .ui-resizable-autohide .ui-resizable-handle { display: none; }
  .ui-resizable-n { cursor: n-resize; height: 7px; width: 100%; top: -5px; left: 0; }
  .ui-resizable-s { cursor: s-resize; height: 7px; width: 100%; bottom: -5px; left: 0; }
  .ui-resizable-e { cursor: e-resize; width: 7px; right: -5px; top: 0; height: 100%; }
  .ui-resizable-w { cursor: w-resize; width: 7px; left: -5px; top: 0; height: 100%; }
  .ui-resizable-se { cursor: se-resize; width: 12px; height: 12px; right: 1px; bottom: 1px; }
  .ui-resizable-sw { cursor: sw-resize; width: 9px; height: 9px; left: -5px; bottom: -5px; }
  .ui-resizable-nw { cursor: nw-resize; width: 9px; height: 9px; left: -5px; top: -5px; }
  .ui-resizable-ne { cursor: ne-resize; width: 9px; height: 9px; right: -5px; top: -5px;}

  
  
  
</style>

<div class="vertical-line system-block">
</div>
<div class="horisontal-line system-block">
</div>
<div class="tag-info system-block">
</div>
<div class="image-preview palette system-block">
  <img class="image"></img>
</div>

<div id="cssPalette" class="palette system-block">
  <div class="css-cell" property="float" value="left">float:left</div>
  <div class="css-cell" property="position" value="absolute">position:absolute</div>
  <div class="css-cell" property="display" value="none">display:none</div>
</div>

<div id="classesPalette" class="palette system-block">
  <div class="class-cell">Class1</div>
  <div class="class-cell">Class2</div>
  <div class="class-cell">Class3</div>
</div>



<prototypes>
  <div class="construction-element">
    <input type="text" class="id-input" value="??????"/><br/>
    <div class="color-place bg-color-place place">фон</div>
    <div class="color-place border-color-place place">борд</div>
    <div class="css-place place">CSS</div>
    <div class="classes-place place">класс</div>
    <div class="menu">
<div class="menuitem designer" icon="delete-mini.png" onclick="DesignerDeleteSelected();" tooltip="Удалить"></div>
<div class="menuitem designer" icon="background-mini.png" onclick="DesignerCropImage()" tooltip="Вырезать из фона"></div>
<div class="menuitem designer" icon="save-mini.png" onclick="DesignerToDiv();" tooltip="Конвертировать в DIV"></div>
  </div>
  
  </div>
  <div id="objects-block"  class="palette system-block content" url="System.ObjectTracker.htm">
  </div>
  
  <style type="text/css" id="contentStylesImport">
    .MRT_IS_OSC-designer-moving
    {
      position: absolute;
      z-index: 103;
      background: white;
      border: dotted 2px blue;
      opacity: 0.3;
    }
    
    .MRT_IS_OSC-selected
    {
      border: solid 1px rgb(255, 0, 255);
    }
    
    .MRT_IS_OSC-selected:hover
    {
      border-style: dotted;
    }
    
    .MRT_IS_OSC-current
    {
      border: solid 1px red;
    }
  </style>
</prototypes>



</div>