<!DOCTYPE html>
<html>
	<head>
		
		<title>Карты</title>
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
		
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Utils.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/DOM.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Url.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Log.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Events.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Ajax.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Jasp.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Modules.js"></script>
		<script type="text/javascript" src="http://Services.web-manufacture.net/Base/v1.3/Net.js" ></script>
		<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript">
			var Map;
			var MyPos;
			function initialize() {     
				var myOptions = {
					zoom: 13,
					center: new google.maps.LatLng(55.452083, 37.370348),
					mapTypeId: google.maps.MapTypeId.HYBRID 
				};
				Map = new google.maps.Map(DOM("#map_canvas"), myOptions); 
				
				if (navigator.geolocation){
					navigator.geolocation.getCurrentPosition(function(arg){
						PlaceMapHolder(arg);
					}, function(error){
						Notify.Error(error);	
					});
				}
				else{
					Notify.Error("Не включена геолокация!");
				}
				
			};
			
			function PlaceMapHolder(pos){
				MyPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
				var marker = new google.maps.Marker({
					position:MyPos,
					map: Map,
					title:"Я нахожусь тут!" 
				});
				Map.setCenter(MyPos);
				DOM.all(".visit").each(function(elem){
					elem.add(".invisible");
					var addr = elem.get(".address").textContent;
					addr = addr.trim();
					var geocoder = new google.maps.Geocoder();
					geocoder.geocode({address: addr}, function(obj){
						if (obj){
							elem.del(".invisible");
							elem.location = obj[0].geometry.location;
							var marker = new google.maps.Marker({
								position: elem.location,
								map: Map,
								title: elem.get(".org-name").textContent.trim() + "\n" + obj[0].formatted_address,
								element : elem
							});
							var infowindow = new google.maps.InfoWindow({content: elem.outerHTML});
							google.maps.event.addListener(marker, 'click', function() {
								marker.element.add(".selected");
								infowindow.open(Map, marker);
							});
						}
					});
					elem.onclick = function(){
						Map.setCenter(this.location);
					}
				});
			};
			
			WS.DOMload(initialize);
		</script>
		<link type='text/css' rel='stylesheet' href="http://system.web-manufacture.net/System.default.css" />
		<style type='text/css'>
			
			
			#map_canvas 
			{ 
				height: 100%;
				width: 70%;
				float: left;
				border-left: solid 5px gray;
			}
			
			#Controls{
				height: 100%;
				width: 29%;
				float: right;
				font-size: 12px;
			}
		</style>
	</head>
	<body class="main" id="body">
		<include url='http://services.web-manufacture.net/ui/Notification.htm'></include>
		<div id="map_canvas"></div>	
		<div id="Controls">
			
		</div>	
	</body>
</html>
