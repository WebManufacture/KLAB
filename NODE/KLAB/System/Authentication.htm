<include url='http://services.web-manufacture.net/Base/v1.3/ui.js'></include>
<include url='http://services.web-manufacture.net/Authentication/HttpErrors.js'></include>
	<style type="text/css">
	    .authenticationForm {
		background-color:  #05a5a0;
		border-radius: 0px 0px 10px 10px;
		top: 0;
		color: white;
		position: fixed;
		right: 0;
		text-align: center;
		width: 250px;
		z-index: 200;
		opacity:0.4;
	    }
	    .authenticationForm:hover{
		opacity: 1;		
	    }
	    .authenticationPanel {
		display: none;
	    }
	    .authenticatedPanel {
		display: none;
	    }
	    
	    .authenticationForm:hover .authenticationPanel{
		display: block;
	    }
	    
	    .authenticationForm a.user-greating {
		color: white;
		text-decoration: none;
	    }
	    
	    .authenticationForm.authenticated .authenticationPanel{
		display: none ;
	    }
	    .authenticationForm.authenticated .authenticatedPanel{
		display: block ;
	    }
	    
	    .authenticationForm .button {
		background:  	#808080;
		border-radius: 2px 2px 10px 10px;
		margin: 5px;
		cursor: pointer;
	    }
	    
	    
	    .authenticationForm .button:hover {
		background: silver;
	    }
	    .authenticationForm #LoginButton.button:active {
		background: teal;
	    }	
	    .authenticationForm #LogoutButton.button:active {
		background: teal;
	    }
	    
	    .authenticationPanel .fields {
		text-align: right;
		position: relative;
		right: 15px;
	   }
	    .authFields {
		padding: 5px;
	    }
	    .authenticationForm.authenticated .authenticatedPanel .button{
		display: none ;
	    }
	    .authenticationForm.authenticated:hover .authenticatedPanel .button{
		display: block ;
	    }
	    
	</style>
	
	<script type="text/javascript">
	    
	    
	    function getXmlHttp(){
		var xmlhttp;
		try {
		    xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (e) {
		    try {
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		    } catch (E) {
			xmlhttp = false;
		    }
		}
		if (!xmlhttp && typeof XMLHttpRequest!='undefined') {
		    xmlhttp = new XMLHttpRequest();
		}
		return xmlhttp;
	    };
	    
	     Auth = Authentication = authentication = M.GetModuleEndsUrl("Authentication.htm");
	    
	    Auth.Init = Auth.main = function(){
		Auth.Form = DOM("#AuthenticationForm");
		WS.Body.ins(Auth.Form);
		//Auth.Form.Get("#LoginButton");
		var loginButton = DOM.get("#LoginButton");
		loginButton.onclick = Auth.authFromForm;
		
		var logoutButton = DOM.get("#LogoutButton");
		logoutButton.onclick = Auth.logout;
		
		var login = localStorage['user-login'];
		var pwd = localStorage['user-pass'];
		
		//var login = 22;
		//var pwd = 333;
		
		Auth.Login = login;
		if (Auth.Login && pwd) {
		    var reqestHash = Auth.ComputeHash(Auth.Login, pwd);// здесь делается хеш из даты и localStorage.getItem('pass')
		    Auth.AuthReqest(Auth.Login, reqestHash);
		};
	    };
	    
	
    
   
    
	    Auth.authFromForm = function(){
		var loginField = DOM.get('#UserLogin');
		var passField = DOM.get('#UserPass');
		var login = loginField.value;
		var pass = passField.value;
		localStorage.setItem('user-login', login);
		localStorage.setItem('user-pass', pass);
		Auth.main();
	    };
	    
	    Auth.logout = function (){
		localStorage.removeItem('user-login');
		localStorage.removeItem('user-pass');
		var elem = DOM.get('#authenticationForm');
		elem.del('.authenticated');
		var elem2 = DOM.get('#UserName');
		elem2.set('Аноним (Войти)');
		var passField = DOM.get('#UserPass');
		passField.value = "";
		Auth.main();
	    };
	    
	    Auth.ComputeHash = function(login, pwd) {
		var date = new Date();
		date = date.formatDateRus() + " " + date.getHours() + ":" + date.getMinutes();
		return sha1(pwd + " " + date);	
	    };
	    
	    
	    Auth.AuthReqest = function(login, reqestHash) {
		var xmlhttp = getXmlHttp();
		var url = Request.GetUrl('http://localhost:8888/Auth', {login: login, hash : reqestHash});
		xmlhttp.open('Get', url, true);
		xmlhttp.onload = Auth.AuthComplete;
		xmlhttp.onerror = Auth.Error;
		xmlhttp.send(null);
	    };
	    
	    Auth.Error = function(error, e2){		
		alert("Ошибка- " + this.status);
		localStorage.removeItem('user-login');
		localStorage.removeItem('user-pass');
		var passField = DOM.get('#UserPass');
		passField.value = "";
		var errorCode = this.status;
		var elem2 = DOM.get('#UserName');
		elem2.set('' + HttpErrors['' + errorCode]);
	    };
	    
	    Auth.AuthComplete = function(result){
		if (this.status != 200) {		    
		    alert("Статус- " + this.status);
		    return;
		}
		var elem = DOM.get('#authenticationForm');
		elem.add('.authenticated');
		var elem2 = DOM.get('#UserName');
		elem2.set('' + Auth.Login);
		
		//ERROR!403Неверный пароль!
		//<div id='AuthResult' class='error icorrect-pwd' error-code='403'>Неверный пароль!</div>
		//"<div id='AuthResult' class='error' error-code='" + errCode + "'>" + errText + "</div>"
		//errCode + errText
		var res = DOM.div();
		res.innerHtml = result;
		//Это наш res
		//<div> 
		//   <div id='AuthResult' class='error icorrect-pwd' error-code='403'>Неверный пароль!</div>
		//</div>
		//{ authResult: "error", code:"403" }
		
		var resreal = res.firstChild;
		if (resreal.is(".error")){
		    
		}
		
		
		//
		var res = DOM.wrap(result);
	    };
	    

	</script>
	
    </head>
    <body>
	
	<include url='http://services.web-manufacture.net/Base/v1.3/ui.js'></include>
	<include url='http://services.web-manufacture.net/UI/toolbars.htm'></include>
	<include url='http://services.web-manufacture.net/UI/Notification.htm'></include>
	
	<div id= 'authenticationForm' class= 'authenticationForm'>  <!-- добавить к этому элементу класс "authenticate" после авторизации -->
	    <div class='header'>
		<a href='#' class='user-greating'><span id='UserName'>Аноним (Войти)</span></a>
	    </div>
	    <div id='authenticationPanel' class = 'authenticationPanel'>
		<div class='fields'>
		    <div class='authFields'>
			<span>Login</span>
			<input id='UserLogin'/>
		    </div>
		    <div class='authFields'>
			<span>Pass</span>
			<input id='UserPass'/>
		    </div>
		</div>	
		<div id='LoginButton' class='button'>Вход</div>
	    </div>
	    <div class = authenticatedPanel>
		<div id='LogoutButton' class='button'>Выйти</div>
	    </div>	    
	</div>
    
</body>
</html>

    
